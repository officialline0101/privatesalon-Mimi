<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>予約フォーム | Private Salon Mimi</title>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        /* =========================================
           変数定義 & リセット
           ========================================= */
        :root {
            --color-bg: #fcfbf9;         /* 背景：温かみのある白 */
            --color-text: #4a4040;       /* 文字：少し濃いめのチャコールブラウン */
            --color-text-light: #8c7b75; /* 薄い文字 */
            --color-accent: #d8aeb5;     /* アクセント：くすみピンク */
            --color-accent-bg: #fff0f5;  /* アクセント背景（薄ピンク） */
            --color-border: #ddd4d4;     /* ボーダー：少し濃くして視認性UP */
            --color-white: #ffffff;
            --font-serif: "Shippori Mincho", "Noto Serif JP", serif;
            --font-sans: "Helvetica Neue", Arial, sans-serif;
            --radius-sm: 6px;            /* 角丸を少し大きく */
            --radius-md: 10px;
            --shadow-card: 0 4px 20px rgba(0, 0, 0, 0.05);
            --shadow-float: 0 10px 25px rgba(216, 174, 181, 0.3);
        }

        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;500;600&family=Shippori+Mincho:wght@400;500;600&display=swap');

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-serif);
            background-color: var(--color-bg);
            background-image: linear-gradient(to bottom, #fff5f7 0%, #fcfbf9 400px);
            color: var(--color-text);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        /* =========================================
           レイアウトコンテナ
           ========================================= */
        .wrapper {
            width: 100%;
            max-width: 600px; /* 幅を少し絞って視線移動を減らす */
            padding: 30px 15px 100px;
            margin: 0 auto;
        }

        .card {
            background-color: rgba(255, 255, 255, 0.98);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-card);
            padding: 40px 30px;
            position: relative;
            border: 1px solid #f0ebeb;
        }

        /* =========================================
           ヘッダー
           ========================================= */
        header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 2px solid var(--color-accent-bg); /* 線を太くして区切りを明確に */
            padding-bottom: 25px;
        }

        h1 {
            font-family: var(--font-serif);
            font-weight: 500;
            font-size: 24px;
            color: var(--color-text);
            margin: 0;
            line-height: 1.4;
        }

        h1 .en-title {
            display: block;
            font-size: 13px;
            color: var(--color-accent);
            font-family: var(--font-sans);
            letter-spacing: 0.15em;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-weight: 600;
        }

        /* =========================================
           フォーム要素共通
           ========================================= */
        .form-group {
            margin-bottom: 40px; /* 余白を広げてセクションごとの区切りを良くする */
        }

        .label-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .label-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
            display: flex;
            align-items: center;
        }
        /* 左側のアクセントバー */
        .label-text::before {
            content: "";
            display: inline-block;
            width: 5px;
            height: 20px;
            background-color: var(--color-accent);
            margin-right: 12px;
            border-radius: 2px;
        }

        /* 必須・任意バッジ */
        .badge {
            font-size: 11px;
            padding: 3px 10px;
            margin-left: 10px;
            border-radius: 12px; /* カプセル型に変更 */
            font-family: var(--font-sans);
            font-weight: bold;
            letter-spacing: 0.05em;
        }
        .badge.required {
            background: var(--color-accent-bg);
            color: var(--color-accent);
            border: 1px solid var(--color-accent);
        }
        .badge.optional {
            background-color: #f2f2f2;
            color: #888;
            border: 1px solid #ddd;
        }

        /* 入力フィールド */
        input[type="text"],
        input[type="tel"],
        textarea,
        select {
            width: 100%;
            padding: 18px; /* タップエリア拡大 */
            font-size: 16px;
            color: var(--color-text);
            background-color: #fff;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-family: var(--font-sans);
            transition: all 0.3s ease;
            appearance: none;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--color-accent);
            background-color: #fffbfc;
            box-shadow: 0 0 0 3px rgba(216, 174, 181, 0.2);
        }

        /* プレースホルダー */
        ::placeholder { color: #bbb; opacity: 1; }

        /* セレクトボックスの矢印 */
        .select-wrapper { position: relative; }
        .select-wrapper::after {
            content: "";
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 4 5'%3E%3Cpath fill='%23d8aeb5' d='M2 0L0 2h4zm0 5L0 3h4z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: contain;
            pointer-events: none;
        }

        /* =========================================
           ボタンデザイン（カテゴリー・メニュー）
           ========================================= */
        .selection-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* ボタン間の隙間を広げる */
        }

        /* 基本ボタン設定 */
        .btn-select {
            background: #fff;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: var(--font-serif);
            font-size: 15px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            /* 影をつけて浮き上がらせる */
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); 
        }

        .btn-select:hover {
            border-color: var(--color-accent);
            background-color: #fffbfb;
        }

        .btn-select.active {
            background-color: var(--color-accent);
            border-color: var(--color-accent);
            color: var(--color-white);
            box-shadow: 0 4px 10px rgba(216, 174, 181, 0.4);
            font-weight: 600;
        }

/* --- カテゴリーボタン（横並び維持） --- */
        .category-buttons .btn-select {
            flex: 1 1 30%;
            text-align: center;
            font-weight: 600;
            white-space: nowrap; /* 【追加】文字の改行を禁止 */
            padding: 16px 2px;   /* 【追加】左右の余白を詰めて文字スペースを確保 */
        }

        /* --- メニューボタン（縦並び1行に変更） --- */
        .menus {
            flex-direction: column; /* 縦並びにする */
        }
        .menus .btn-select {
            width: 100%;
            text-align: left; /* 左寄せ */
            padding: 20px 25px; /* 高さを出して押しやすく */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* メニューボタン右側のアイコン */
        .menus .btn-select::after {
            content: "＋";
            font-family: sans-serif;
            font-size: 18px;
            color: #ddd;
            font-weight: 300;
        }
        .menus .btn-select.active::after {
            content: "✔";
            color: #fff;
        }

        /* --- オプションボタン（2列維持 or お好みで1列） --- */
        /* ※見やすさのため、オプションも少し大きく2列配置 */
        .options .btn-select {
            flex: 1 1 45%; 
            text-align: center;
        }

        /* メニューコンテナ（アコーディオン部分） */
        .menu-container {
            display: none;
            background: #fdfcfc;
            padding: 30px 20px;
            border-radius: var(--radius-md);
            margin-top: 25px;
            border: 1px dashed var(--color-border);
            animation: fadeIn 0.5s ease;
        }
        .menu-container.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .sub-label {
            font-size: 14px;
            color: var(--color-accent);
            margin-bottom: 15px;
            display: block;
            font-family: var(--font-sans);
            letter-spacing: 0.1em;
            font-weight: bold;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        /* =========================================
           日時選択
           ========================================= */
        .datetime-wrapper {
            background: #fff;
        }
        .placeholder-text {
            color: var(--color-accent);
            font-size: 14px;
            text-align: center;
            margin-bottom: 10px;
            display: block;
            background: #fffafa;
            padding: 8px;
            border-radius: 4px;
        }
        .dt-grid {
            display: flex;
            gap: 15px;
        }
        .dt-grid .select-wrapper {
            flex: 1;
        }

        .time-disabled {
            background-color: #f9f9f9 !important;
            color: #ccc !important;
            border-color: #eee !important;
            pointer-events: none;
        }

        /* =========================================
           確認エリア（チケット風）
           ========================================= */
        .confirmation-card {
            background: #fff;
            border: 2px solid #eee; /* 枠を少し強調 */
            padding: 25px 30px;
            border-radius: 4px;
            position: relative;
        }
        .confirmation-card::before {
            content: "";
            display: block;
            border-top: 4px double #eee;
            margin-bottom: 25px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: 15px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        .info-row:last-child { border-bottom: none; }

        .info-label {
            font-size: 14px;
            color: var(--color-text-light);
            font-weight: 600;
            width: 90px;
            flex-shrink: 0;
        }
        .info-value {
            font-size: 16px;
            color: var(--color-text);
            text-align: right;
            flex-grow: 1;
            padding-right: 15px;
            font-weight: 500;
        }
        .edit-link {
            font-size: 12px;
            color: var(--color-accent);
            text-decoration: underline;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            white-space: nowrap;
        }

        /* =========================================
           送信ボタン
           ========================================= */
        .submit-area {
            margin-top: 50px;
            text-align: center;
        }
        
        .submit-button {
            width: 100%;
            padding: 22px;
            background: linear-gradient(135deg, #e4c4c9 0%, #d8aeb5 100%);
            color: #fff;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 18px;
            font-weight: 600;
            font-family: var(--font-serif);
            letter-spacing: 0.15em;
            cursor: pointer;
            box-shadow: var(--shadow-float);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(216, 174, 181, 0.5);
        }

        /* =========================================
           右下固定ナビ
           ========================================= */
        .side-nav {
            position: fixed;
            right: 20px;
            bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid var(--color-accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .side-nav a { color: var(--color-accent); text-decoration: none; font-size: 18px; }

        /* =========================================
           SPレスポンシブ
           ========================================= */
        @media (max-width: 480px) {
            .wrapper { padding: 20px 15px 80px; }
            .card { padding: 30px 20px; }
            h1 { font-size: 22px; }
            
            /* スマホではオプションも1列にしてさらに押しやすくする */
            .options .btn-select { flex: 1 1 100%; text-align: left; }
            
            .info-row { flex-wrap: wrap; }
            .info-value { text-align: left; padding-left: 0; width: 100%; margin-top: 5px; }
        }
    </style>
</head>

<body>
    <div class="side-nav">
        <a href="#submitSection">
            <i class="fas fa-arrow-down"></i>
        </a>
    </div>

    <div class="wrapper">
        <div class="card">
            
            <header>
                <h1>
                    <span class="en-title">Private Salon Mimi</span>
                    ご予約フォーム
                </h1>
            </header>

            <div class="form-group" id="nameSection">
                <div class="label-row">
                    <span class="label-text">お名前</span>
                    <span class="badge required">必須</span>
                </div>
                <input type="text" id="name" placeholder="山田 花子">
            </div>

            <div class="form-group">
                <div class="label-row">
                    <span class="label-text">電話番号</span>
                    <span class="badge required">必須</span>
                </div>
                <input type="tel" id="phone" placeholder="090-1234-5678">
            </div>

            <div class="form-group">
                <div class="label-row">
                    <span class="label-text">年代</span>
                    <span class="badge optional">任意</span>
                </div>
                <div class="select-wrapper">
                    <select id="age">
                        <option value="">年代を選択してください</option>
                        <option value="10代">10代</option>
                        <option value="20代">20代</option>
                        <option value="30代">30代</option>
                        <option value="40代">40代</option>
                        <option value="50代">50代</option>
                        <option value="60代以上">60代以上</option>
                    </select>
                </div>
            </div>

            <div class="form-group" id="menuArea">
                <div class="label-row">
                    <span class="label-text">メニュー</span>
                    <span class="badge required">必須</span>
                </div>
                <p style="text-align:center; font-size:14px; color:#999; margin-bottom:15px;">ご希望のカテゴリーをお選びください</p>
                
                <div class="selection-group category-buttons">
                    <button type="button" class="btn-select" onclick="selectCategory('aroma')">アロマリンパ</button>
                    <button type="button" class="btn-select" onclick="selectCategory('body')">もみほぐし</button>
                    <button type="button" class="btn-select" onclick="selectCategory('head')">ヘッドスパ</button>
                </div>

                <div id="cat-aroma" class="menu-container">
                    <span class="sub-label">MENU（1つ選択）</span>
                    <div class="selection-group menus">
                        <button type="button" class="btn-select" onclick="selectMenuItem(this, 60)">アロマリンパ 60分</button>
                        <button type="button" class="btn-select" onclick="selectMenuItem(this, 90)">アロマリンパ 90分</button>
                        <button type="button" class="btn-select" onclick="selectMenuItem(this, 120)">アロマリンパ 120分</button>
                    </div>
                    <div style="height:30px;"></div>
                    <span class="sub-label">OPTION（複数選択可）</span>
                    <div class="selection-group options">
                        <button type="button" class="btn-select" onclick="toggleOption(this, 30)">部分リンパ 30分</button>
                        <button type="button" class="btn-select" onclick="toggleOption(this, 30)">ドライヘッド 30分</button>
                        <button type="button" class="btn-select" onclick="toggleOption(this, 30)">足つぼ 30分</button>
                    </div>
                </div>

                <div id="cat-body" class="menu-container">
                    <span class="sub-label">MENU（1つ選択）</span>
                    <div class="selection-group menus">
                        <button type="button" class="btn-select" onclick="selectMenuItem(this, 60)">全身もみほぐし 60分</button>
                        <button type="button" class="btn-select" onclick="selectMenuItem(this, 90)">全身もみほぐし 90分</button>
                        <button type="button" class="btn-select" onclick="selectMenuItem(this, 120)">全身もみほぐし 120分</button>
                        <button type="button" class="btn-select" onclick="selectMenuItem(this, 60)">強もみ指圧 60分</button>
                    </div>
                    <div style="height:30px;"></div>
                    <span class="sub-label">OPTION（複数選択可）</span>
                    <div class="selection-group options">
                        <button type="button" class="btn-select" onclick="toggleOption(this, 30)">部分リンパ 30分</button>
                        <button type="button" class="btn-select" onclick="toggleOption(this, 30)">ドライヘッド 30分</button>
                        <button type="button" class="btn-select" onclick="toggleOption(this, 30)">足つぼ 30分</button>
                    </div>
                </div>

                <div id="cat-head" class="menu-container">
                    <span class="sub-label">MENU（1つ選択）</span>
                    <div class="selection-group menus">
                        <button type="button" class="btn-select" onclick="selectMenuItem(this, 45)">ドライヘッドスパ 45分</button>
                    </div>
                    <div style="height:30px;"></div>
                    <span class="sub-label">OPTION（複数選択可）</span>
                    <div class="selection-group options">
                        <button type="button" class="btn-select" onclick="toggleOption(this, 30)">部分リンパ 30分</button>
                        <button type="button" class="btn-select" onclick="toggleOption(this, 30)">足つぼ 30分</button>
                    </div>
                </div>
            </div>

            <div class="form-group" id="kibou1">
                <div class="label-row">
                    <span class="label-text">第一希望日時</span>
                    <span class="badge required">必須</span>
                </div>
                <div class="datetime-wrapper">
                    <span class="placeholder-text" id="placeholder1">ご希望の日時を選択してください</span>
                    <input type="hidden" id="date1">
                    <div class="dt-grid">
                        <div class="select-wrapper">
                            <select id="date1_day" class="datetime-input"></select>
                        </div>
                        <div class="select-wrapper">
                            <select id="date1_time" class="datetime-input"></select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group" id="kibou2">
                <div class="label-row">
                    <span class="label-text">第二希望日時</span>
                    <span class="badge optional">任意</span>
                </div>
                <div class="datetime-wrapper">
                    <span class="placeholder-text" id="placeholder2">ご希望の日時を選択してください</span>
                    <input type="hidden" id="date2">
                    <div class="dt-grid">
                        <div class="select-wrapper">
                            <select id="date2_day" class="datetime-input"></select>
                        </div>
                        <div class="select-wrapper">
                            <select id="date2_time" class="datetime-input"></select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="label-row">
                    <span class="label-text">ご要望・ご質問</span>
                </div>
                <textarea id="message" rows="4" placeholder="お疲れの箇所や、施術に関するご希望がございましたらご記入ください。"></textarea>
            </div>

            <div class="form-group">
                <div class="label-row" style="justify-content:center;">
                    <span class="label-text" style="font-size:18px;">ご予約内容の確認</span>
                </div>
                <div class="confirmation-card" id="displayInfo">
                    </div>
            </div>

            <div class="submit-area" id="submitSection">
                <button class="submit-button" onclick="submitForm()">予約をリクエストする</button>
            </div>

        </div></div><script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script>
        // --- 状態管理用変数 ---
        let currentCategory = null;
        let selectedMenuName = null;
        let selectedMenuTime = 0;
        let selectedOptions = []; // {name: string, time: number} の配列
        
        // --- 設定定数 ---
        const JP_WD = ['日', '月', '火', '水', '木', '金', '土'];
        const pad = n => String(n).padStart(2, '0');

// 営業時間設定
        const WEEKLY_HOURS = {
            0: { start: 11, end: 22 }, // 日
            1: { start: 11, end: 22 }, // 月
            2: { start: 11, end: 22 }, // 火
            3: { start: 11, end: 22 }, // 水
            4: { start: 11, end: 22 }, // 木
            5: { start: 11, end: 22 }, // 金
            6: { start: 11, end: 22 }  // 土
        };

        // 初期化処理
        document.addEventListener('DOMContentLoaded', function () {
            liff.init({ liffId: '2008876471-6CNdbSNZ' })
                .then(() => console.log('LIFF OK'))
                .catch((err) => console.error('LIFF Error', err));

            restoreInput('name');
            restoreInput('phone');
            initDatePickers(['date1', 'date2']);
            updateDisplayInfo();

            document.getElementById('name').addEventListener('input', () => {
                saveInput('name');
                updateDisplayInfo();
            });
            document.getElementById('phone').addEventListener('input', () => {
                saveInput('phone');
                updateDisplayInfo();
            });
            document.getElementById('age').addEventListener('change', updateDisplayInfo);
            document.getElementById('message').addEventListener('input', updateDisplayInfo);
        });

        // --- カテゴリー・メニュー・オプション操作 ---

        function selectCategory(catId) {
            currentCategory = catId;
            selectedMenuName = null;
            selectedMenuTime = 0;
            selectedOptions = [];

            document.querySelectorAll('.category-buttons .btn-select').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.menu-container').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(`cat-${catId}`);
            if (target) {
                target.classList.add('active');
                target.querySelectorAll('.btn-select').forEach(btn => btn.classList.remove('active'));
            }

            updateDisplayInfo();
        }

        function selectMenuItem(btn, time) {
            const parent = btn.closest('.menus');
            parent.querySelectorAll('.btn-select').forEach(b => b.classList.remove('active'));
            
            btn.classList.add('active');
            selectedMenuName = btn.textContent; // "＋"などの装飾文字が入らないよう注意が必要だがCSS contentなら大丈夫
            selectedMenuTime = time;

            updateDisplayInfo();
        }

        function toggleOption(btn, time) {
            btn.classList.toggle('active');
            const name = btn.textContent;

            if (btn.classList.contains('active')) {
                selectedOptions.push({ name: name, time: time });
            } else {
                selectedOptions = selectedOptions.filter(opt => opt.name !== name);
            }
            updateDisplayInfo();
        }

        // --- 表示更新ロジック ---
        function updateDisplayInfo() {
            const name = document.getElementById('name').value;
            const age = document.getElementById('age').value;
            
            const totalTime = selectedMenuTime + selectedOptions.reduce((sum, opt) => sum + opt.time, 0);
            const hours = Math.floor(totalTime / 60);
            const minutes = totalTime % 60;
            const timeStr = totalTime > 0 ? `${hours > 0 ? hours + '時間' : ''}${minutes}分` : '---';

            let menuHtml = '未選択';
            if (selectedMenuName) {
                menuHtml = `${selectedMenuName}`;
            }

let optionHtml = 'なし';
            if (selectedOptions.length > 0) {
                // 変更前： optionHtml = selectedOptions.map(o => `${o.name}`).join(' / ');
                
                // 変更後：ここを <br> に変えると改行されます
                optionHtml = selectedOptions.map(o => `${o.name}`).join('<br>');
            }

            const d1 = formatDisplayDate(document.getElementById('date1').value);
            const d2 = formatDisplayDate(document.getElementById('date2').value);

            const html = `
                <div class="info-row">
                    <span class="info-label">お名前</span>
                    <span class="info-value">${name || '<span style="color:#ccc">未入力</span>'}</span>
                    <button class="edit-link" onclick="scrollToId('nameSection')">修正</button>
                </div>
                <div class="info-row">
                    <span class="info-label">年代</span>
                    <span class="info-value">${age || '-'}</span>
                    <button class="edit-link" onclick="scrollToId('age')">修正</button>
                </div>
                <div class="info-row">
                    <span class="info-label">メニュー</span>
                    <span class="info-value">${menuHtml}</span>
                    <button class="edit-link" onclick="scrollToId('menuArea')">修正</button>
                </div>
                <div class="info-row">
                    <span class="info-label">オプション</span>
                    <span class="info-value">${optionHtml}</span>
                    <button class="edit-link" onclick="scrollToId('menuArea')">修正</button>
                </div>
                <div class="info-row">
                    <span class="info-label">所要時間</span>
                    <span class="info-value">${timeStr}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">第一希望</span>
                    <span class="info-value">${d1 || '<span style="color:#ccc">未選択</span>'}</span>
                    <button class="edit-link" onclick="scrollToId('kibou1')">修正</button>
                </div>
                <div class="info-row">
                    <span class="info-label">第二希望</span>
                    <span class="info-value">${d2 !== '未選択' ? d2 : '-'}</span>
                    <button class="edit-link" onclick="scrollToId('kibou2')">修正</button>
                </div>
            `;
            document.getElementById('displayInfo').innerHTML = html;
        }

        // --- 日時ピッカー関連 ---
        function initDatePickers(ids) {
            ids.forEach(id => {
                const daySel = document.getElementById(`${id}_day`);
                const timeSel = document.getElementById(`${id}_time`);
                
                buildDateOptions(daySel, 90);

                timeSel.innerHTML = '<option value="" selected disabled>時間</option>';
                timeSel.classList.add('time-disabled');

                daySel.addEventListener('change', () => {
                    const val = daySel.value;
                    if (val) {
                        const dateObj = new Date(val);
                        const wd = dateObj.getDay();
                        buildTimeOptions(timeSel, wd);
                        timeSel.classList.remove('time-disabled');
                    } else {
                        timeSel.innerHTML = '<option value="" selected disabled>時間</option>';
                        timeSel.classList.add('time-disabled');
                    }
                    updateHiddenValue(id);
                });

                timeSel.addEventListener('change', () => {
                    updateHiddenValue(id);
                });
            });
        }

        function buildDateOptions(select, days) {
            select.innerHTML = '<option value="" selected disabled>日付</option>';
            const d = new Date();
            for (let i = 0; i < days; i++) {
                const y = d.getFullYear();
                const m = pad(d.getMonth() + 1);
                const dd = pad(d.getDate());
                const wd = d.getDay();
                
                const val = `${y}-${m}-${dd}`;
                const txt = `${m}/${dd}(${JP_WD[wd]})`;
                
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = txt;
                select.appendChild(opt);

                d.setDate(d.getDate() + 1);
            }
        }

        function buildTimeOptions(select, wd) {
            select.innerHTML = '<option value="" selected disabled>時間</option>';
            const conf = WEEKLY_HOURS[wd];
            if (!conf) return;

            for (let h = conf.start; h <= conf.end; h++) {
                for (let m of [0, 30]) {
                    const timeStr = `${pad(h)}:${pad(m)}`;
                    const opt = document.createElement('option');
                    opt.value = timeStr;
                    opt.textContent = timeStr;
                    select.appendChild(opt);
                }
            }
        }

        function updateHiddenValue(baseId) {
            const d = document.getElementById(`${baseId}_day`).value;
            const t = document.getElementById(`${baseId}_time`).value;
            const hidden = document.getElementById(baseId);
            const ph = document.getElementById(`placeholder${baseId.slice(-1)}`);

            if (d && t) {
                hidden.value = `${d} ${t}`;
                ph.style.display = 'none';
            } else {
                hidden.value = '';
                ph.style.display = 'block';
            }
            updateDisplayInfo();
        }

        function formatDisplayDate(val) {
            if (!val) return '未選択';
            const [datePart, timePart] = val.split(' ');
            const [y, m, d] = datePart.split('-');
            return `${m}月${d}日 ${timePart}`;
        }

        function saveInput(id) {
            localStorage.setItem(id, document.getElementById(id).value);
        }
        function restoreInput(id) {
            const val = localStorage.getItem(id);
            if (val) document.getElementById(id).value = val;
        }
        function scrollToId(id) {
            const el = document.getElementById(id);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function submitForm() {
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const age = document.getElementById('age').value;
            const date1 = document.getElementById('date1').value;
            const date2 = document.getElementById('date2').value;
            const message = document.getElementById('message').value;

            if (!name) { alert('お名前を入力してください'); return; }
            if (!phone) { alert('電話番号を入力してください'); return; }
            if (!selectedMenuName) { alert('メニューを選択してください'); return; }
            if (!date1) { alert('第一希望日時を入力してください'); return; }

            let optionsText = 'なし';
            if (selectedOptions.length > 0) {
                optionsText = selectedOptions.map(o => o.name).join(', ');
            }

            const sendText = `【予約リクエスト】
《お名前》
${name}
《電話番号》
${phone}
《年代》
${age || '未選択'}

《ご希望メニュー》
${selectedMenuName}
《オプション》
${optionsText}

《第一希望》
${formatDisplayDate(date1)}
《第二希望》
${formatDisplayDate(date2) !== '未選択' ? formatDisplayDate(date2) : 'なし'}

《備考》
${message || 'なし'}`;

            if (!liff.isInClient()) {
                alert('LINEアプリ内から開いてください。\n\n送信内容プレビュー:\n' + sendText);
                return;
            }

            liff.sendMessages([{ type: 'text', text: sendText }])
                .then(() => {
                    liff.closeWindow();
                })
                .catch((err) => {
                    console.error(err);
                    alert('送信に失敗しました。');
                });
        }
    </script>
</body>
</html>
